---
title: プロファイル ガイド付き最適化 |Microsoft ドキュメント
ms.custom: ''
ms.date: 03/14/2018
ms.technology:
- cpp-tools
ms.topic: article
dev_langs:
- C++
helpviewer_keywords:
- profile-guided optimizations
- optimization, profile-guided [C++]
ms.assetid: 2225c307-d3ae-42c1-8345-a5a959d132dc
author: corob-msft
ms.author: corob
manager: ghogen
ms.workload:
- cplusplus
ms.openlocfilehash: 8ca4c79fd46954d59a8fdd892fabbd53d4bc985f
ms.sourcegitcommit: ee7d74683af7631441c8c7f65ef5ceceaee4a5ee
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/22/2018
---
# <a name="profile-guided-optimizations"></a>ガイド付き最適化のプロファイル

ガイド付き最適化のプロファイルによって出力ファイルを最適化できます。この場合、オプティマイザーは .exe ファイルまたは .dll ファイルのテスト実行データを使用します。 このデータは、稼働環境でのプログラムの実行動作を示します。

プロファイル ガイド付き最適化のでは、x86 または x64 のネイティブ ターゲットの使用のみです。 プロファイル ガイド付き最適化のでは、共通言語ランタイムで実行する出力ファイルで使用できません。 ネイティブおよびマネージの混合コードを持つアセンブリを生成した場合でも (を使用して、 **/clr**コンパイラ オプション)、ネイティブ コードだけでプロファイル ガイド付き最適化を使用することはできません。 これらのオプション、IDE のセットで、プロジェクトをビルドしようとする場合、ビルド エラーが発生します。

> [!NOTE]
> プロファイリングのテスト実行から収集される情報のオーバーライド内にある効果を指定する場合の最適化**/Ob**、 **/Os**、または**/Ot**です。 詳細については、次を参照してください。 [/Ob (関数のインライン展開)](../../build/reference/ob-inline-function-expansion.md)と[/Os、/Ot (実行速度の優先/os)](../../build/reference/os-ot-favor-small-code-favor-fast-code.md)です。

## <a name="steps-to-optimize-your-app"></a>アプリを最適化するために手順を実行します。

プロファイルのガイド付き最適化を使用するのには、次のアプリを最適化するために次の手順を実行します。

- 1 つまたは複数のソース コード ファイルをコンパイル[/GL](../../build/reference/gl-whole-program-optimization.md)です。

   各モジュールでビルドされた**/GL**プロファイル ガイド付き最適化の実行時の動作をキャプチャするテストの実行中に調べることができます。 プロファイル ガイド付き最適化のビルドのすべてのモジュールを使用してコンパイルする必要はありません**/GL**です。 ただし、これらのモジュールのみコンパイルで**/GL**プロファイル ガイド付き最適化のインストルメント化され、後で使用できるはします。

- 使用してリンク[/LTCG](../../build/reference/ltcg-link-time-code-generation.md)と[/GENPROFILE または/FASTGENPROFILE](../../build/reference/genprofile-fastgenprofile-generate-profiling-instrumented-build.md)です。

   両方を使用して**/LTCG**と**/GENPROFILE**または**/FASTGENPROFILE**インストルメント化されたアプリの実行時に .pgd ファイルを作成します。 テスト実行データが追加された .pgd ファイルは、次のリンク ステップ (最適化イメージの作成) での入力として使用できます。 指定するときに**/GENPROFILE**、必要に応じて追加することができます、 **PGD =**_filename_既定以外の名前または .pgd ファイルの場所を指定する引数。 組み合わせ**/LTCG**と**/GENPROFILE**または**/FASTGENPROFILE**リンカー オプションを非推奨置き換えます**/LTCG:PGINSTRUMENT**リンカーのオプションです。

- アプリケーションのプロファイリングを行います。

   たびに、プロファイリングされた EXE セッションが終了またはプロファイリングされた DLL がアンロード、 *appname*! # .pgc ファイルを作成します。 .pgc ファイルには、特定のアプリケーションのテスト実行情報が含まれます。 # は他の番号に基づいたにインクリメントされる 1 から始まる番号*appname*!!#.pgc ファイル ディレクトリにします。 テスト実行の結果が目的の最適化のシナリオを示さない場合は、.pgc ファイルを削除できます。

   テストの実行中に、現在開いている .pgc ファイルのクロージャと使用して新しい .pgc ファイルの作成を強制することができます、 [pgosweep](../../build/reference/pgosweep.md) (たとえば、テスト シナリオの最後は、アプリケーションのシャット ダウンと一致しない) 場合は、ユーティリティです。

   アプリケーションでは、PGO 関数を呼び出すことができますも直接[PgoAutoSweep](pgoautosweep.md)、.pgc ファイルとして呼び出しの時点でプロファイル データをキャプチャします。 .Pgc ファイルにキャプチャされたデータを対象となるコードをより細かく制御が得られます。 この関数を使用する方法の例は、次を参照してください。、 [PgoAutoSweep](pgoautosweep.md)ドキュメント。

   既定では、インストルメント化されたビルドを作成するときに、データ コレクションはスレッド セーフ モードで高速ですが、完全に正確でない場合がありますで行われます。 使用して、 **EXACT**引数**/GENPROFILE**または**/FASTGENPROFILE**が遅くなりますより正確なスレッド セーフ モードでのデータ コレクションを指定できます。 このオプションは、非推奨に設定した場合も[PogoSafeMode](environment-variables-for-profile-guided-optimizations.md#pogosafemode)環境変数、または、非推奨**/POGOSAFEMODE**リンカー オプション、インストルメント化されたビルドを作成するときにします。

- 使用してリンク**/LTCG**と**/USEPROFILE**です。

   両方を使用して、 **/LTCG**と[/USEPROFILE](useprofile.md)リンカー オプションを最適化されたイメージを作成します。 このステップでは、.pgd ファイルを入力として使用します。 指定すると**/USEPROFILE**、必要に応じて追加することができます、 **PGD =**_filename_既定以外の名前または .pgd ファイルの場所を指定する引数。 非推奨を使用して、この名前を指定することも**/PGD**リンカー オプション。 組み合わせ**/LTCG**と**/USEPROFILE** 、非推奨が置き換えられます**/LTCG:PGOPTIMIZE**と**/LTCG:PGUPDATE**リンカー オプション。

最適化された出力ファイルを作成し、追加のプロファイリングによりさらに最適化されたイメージを作成できるかどうかを後で判断することもできます。 インストルメントされたイメージとその .pgd ファイルが使用可能な場合は、追加のテストの実行を行うしより新しい .pgd ファイルと同じを使用して、最適化されたイメージを再構築**/LTCG**と**/USEPROFILE**リンカー オプション.

## <a name="optimizations-performed-by-pgo"></a>PGO によって行われる最適化

ガイド付き最適化のプロファイルの一覧を次に示します。

- **インライン展開**- たとえば、関数 A 関数を B を頻繁に呼び出すことし、関数 B が比較的小さい場合、プロファイル ガイド付き最適化の関数 A. でインライン関数 B が存在する場合

- **仮想呼び出し推理**-仮想呼び出し、またはその他の呼び出し、関数ポインターを通じて対象が特定の関数が頻繁に、プロファイルのガイド付き最適化が挿入され、条件付きで実行される直接呼び出しを頻繁に対象となる関数直接の呼び出しをインライン展開できます。

- **レジスタの割り当て**- 向上レジスタの割り当てのプロファイル データの結果を最適化します。

- **基本ブロックの最適化**-基本ブロックの最適化により、同じ一連のページ (場所) に配置するのには特定のフレーム内で一時的に実行される一般的な実行の基本的な要素です。 これにより使用されるページ数が最小限に抑えられ、メモリのオーバーヘッドが最小限になります。

- **サイズ/速度の最適化**-プログラムが、多くの時間を費やす関数の速度を最適化できます。

- **関数のレイアウト**呼び出し先に基づいており、呼び出し元/呼び出し先の動作のプロファイル - 同じ実行パスになる可能性がある関数が同じセクション内に配置します。

- **条件付き分岐の最適化**- 値プローブをプロファイルのガイド付き最適化の switch ステートメントで指定された値がその他の値よりも頻繁に使用されるかどうかを見つけることができます。  この値は switch ステートメントから取得できます。  また、if ブロックまたは else ブロックのどちらがより頻繁に true になるかに応じて、このどちらかのブロックを最初に置くようにオプティマイザーが if/else を並べ替えることができる場合には、これと同じことを if/else 命令でも行うことができます。

- **コードの分離**-プロファイル中に呼び出されていないコードは、一連のセクションの末尾に追加される特別なセクションに移動します。 これにより、頻繁に使用されるページからこのセクションが切り離されます。

- **EH コードの分離**-プロファイル ガイド付き最適化のでは、例外的な条件でのみ、例外が発生することを確認できる場合、的に実行される EH コードを別のセクションに移動多くの場合、ことができます。

- **メモリの組み込み**-組み込みの拡張によく判断できますを組み込みが頻繁に呼び出される場合は、特定できない場合。 また、組み込みは、移動またはコピーのブロック サイズに基づいて最適化することもできます。

Visual Studio 2013 を使用する場合、自動使える[プロファイル ガイド付き最適化のプラグイン](../../build/reference/profile-guided-optimization-in-the-performance-and-diagnostics-hub.md)に Visual Studio 内で、最適化プロセスを簡素化し、パフォーマンスと診断ハブでの Visual C のです。 このプラグインは以降のバージョンの Visual Studio で使用できます。

## <a name="next-steps"></a>次の手順

これらの環境変数、関数、およびプロファイル ガイド付き最適化に使用できるツールに関する詳細を参照してください。

[ガイド付き最適化のプロファイルの環境変数](../../build/reference/environment-variables-for-profile-guided-optimizations.md)<br/>
テストのシナリオの実行時動作を指定するは、これらの変数を使用できます。 新しいリンカー オプションを優先して廃止されました。このリンカー オプションを環境変数から移動するためにテキストを読み取る。

[PgoAutoSweep](pgoautosweep.md)<br/>
関数の粒度の細かい .pgc ファイル データのキャプチャの制御を提供するアプリに追加することができます。

[pgosweep](../../build/reference/pgosweep.md)<br/>
.Pgc ファイルにすべてのプロファイル データを書き込むコマンド ライン ユーティリティは、.pgc ファイルを閉じて、新しい .pgc ファイルを開きます。

[pgomgr](../../build/reference/pgomgr.md)<br/>
.Pgd ファイルを 1 つまたは複数の .pgc ファイルからプロファイル データを追加するコマンド ライン ユーティリティです。

[方法: 複数の PGO プロファイルを 1 つのプロファイルにマージ](../../build/reference/how-to-merge-multiple-pgo-profiles-into-a-single-profile.md)の例については**pgomgr**使用します。

## <a name="see-also"></a>関連項目

[C と C++ のビルド ツール](../../build/reference/c-cpp-build-tools.md)

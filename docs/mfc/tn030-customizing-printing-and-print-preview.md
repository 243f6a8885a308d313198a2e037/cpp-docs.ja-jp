---
title: "テクニカル ノート 30: 印刷と印刷プレビューのカスタマイズ | Microsoft Docs"
ms.custom: ""
ms.date: "12/03/2016"
ms.prod: "visual-studio-dev14"
ms.reviewer: ""
ms.suite: ""
ms.technology: 
  - "devlang-cpp"
ms.tgt_pltfrm: ""
ms.topic: "article"
f1_keywords: 
  - "vc.print"
dev_langs: 
  - "C++"
helpviewer_keywords: 
  - "カスタマイズ (印刷と印刷プレビューを)"
  - "印刷プレビュー, カスタマイズ"
  - "印刷 [MFC], ビュー"
  - "印刷 (ビューの)"
  - "TN030"
ms.assetid: 32744697-c91c-41b6-9a12-b8ec01e0d438
caps.latest.revision: 9
caps.handback.revision: 5
author: "mikeblome"
ms.author: "mblome"
manager: "ghogen"
---
# テクニカル ノート 30: 印刷と印刷プレビューのカスタマイズ
[!INCLUDE[vs2017banner](../assembler/inline/includes/vs2017banner.md)]

> [!NOTE]
>  次のテクニカル ノートは、最初にオンライン ドキュメントの一部とされてから更新されていません。  結果として、一部のプロシージャおよびトピックが最新でないか、不正になります。  最新の情報について、オンライン ドキュメントのキーワードで関係のあるトピックを検索することをお勧めします。  
  
 ここでは、印刷、印刷プレビューのカスタマイズするプロセスについて説明し、`CView` で使用されるコールバック ルーチンの目的と **CPreviewView**コールバック ルーチン、およびメンバー関数について説明します。  
  
## 問題  
 MFC は、ほとんどの印刷や印刷プレビューのニーズに完全なソリューションを提供します。  ほとんどの場合、小さいコードを追加し、印刷プレビューできます。できるビューを持つ必要があります。  ただし、印刷を最適化する開発者に向かっての多くの工数を必要とする、一部のアプリケーションでは、印刷プレビュー モードに固有のユーザー インターフェイス要素を追加する必要があります方法があります。  
  
## 効率的な印刷  
 MFC アプリケーションの標準的な方法を使用して印刷すると、Windows は、インメモリ メタファイルにすべてのグラフィカル デバイス インターフェイス \(GDI\) の出力呼び出しを転送します。  `EndPage` が呼び出されると、Windows は 1 ページを印刷できるようにプリンターが要求する物理的なバンドにつきメタファイルを一度します。  この描画中に、GDI は頻繁に従う必要があるかどうかを判断するためにアボート プロシージャを呼び出します。  通常、アボート プロシージャは、ユーザーが印刷ダイアログを使用して印刷ジョブを中止するようにメッセージが処理されるようにします。  
  
 ただし、これは印刷プロセスが遅れる可能性があります。  標準的な技法を使用して実行することがあります。速くなければアプリケーションの出力が必要な場合は、手動バンド処理を実装しなければなりません。  
  
## 印刷バンド処理  
 `OnPrint` を複数回ページごとに呼び出されます。手動でバンドがしない、実装について印刷ループのようにする必要があります \(一度バンド単位\)。  印刷ループは viewprnt.cpp の **OnFilePrint** 関数で実装されます。  `CView`\-処理のメッセージ マップ エントリが印刷コマンド出力関数を呼び出すと、派生クラスは、この関数をオーバーロードします。  **OnFilePrint** ルーチンをコピーし、実装のバンド処理に印刷ループを変更します。  印刷するページのセクションにより、レンダリングを最適化するために、印刷、関数にバンド処理の四角形を渡す必要があります。  
  
 2 番目にバンドを描画するときに、`QueryAbort` を呼び出す必要があります。  それ以外の場合、アボート プロシージャは呼び出されず、ユーザーは印刷ジョブを取り消すことはできません。  
  
## 印刷プレビュー: ユーザー インターフェイスを持つ電子文書  
 印刷プレビュー、主に、プリンターのエミュレーションに表示を回転します。  既定でが、メイン ウィンドウのクライアント領域 \(ウィンドウ内のファイル ページを完全に表示するために使用されます。  ユーザーがページの領域にズーム イン、の詳細を参照することもできます。  追加サポートにより、ユーザーがプレビュー モードでドキュメントを編集することができる場合があります。  
  
## 印刷プレビューのカスタマイズ  
 ここでは、変更の印刷プレビューの 1 種類の側面をのみ処理: プレビュー モードに UI を追加します。  ほかの変更は実行できますが、このような変更は、この説明の範囲外にあります。  
  
## UI をプレビュー モードに追加するには  
  
1.  **CPreviewView**からビュー クラスを派生してください。  
  
2.  必要な UI のためのコマンド ハンドラーを追加します。  
  
3.  表示するビジュアルな部分を追加した場合は、`OnDraw` をオーバーライドし、**CPreviewView::OnDraw.**を呼び出した後で描画を実行します。  
  
## OnFilePrintPreview  
 これは、印刷プレビューのコマンド ハンドラーです。  既定の実装では、次の操作:  
  
```  
void CView::OnFilePrintPreview()  
{  
    // In derived classes, implement special window handling here  
    // Be sure to Unhook Frame Window close if hooked.  
  
    // must not create this on the frame. Must outlive this function  
    CPrintPreviewState* pState = new CPrintPreviewState;  
  
    if (!DoPrintPreview(AFX_IDD_PREVIEW_TOOLBAR, this,  
                RUNTIME_CLASS(CPreviewView), pState))  
    {  
        // In derived classes, reverse special window handling  
        // here for Preview failure case  
  
        TRACE0("Error: DoPrintPreview failed");  
        AfxMessageBox(AFX_IDP_COMMAND_FAILURE);  
        delete pState;      // preview failed to initialize,   
                    // delete State now  
    }  
}  
```  
  
 **DoPrintPreview** は アプリケーションのメイン ペインを非表示にします。  コントロール バー、ステータス バーのような pState\-の**dwStates** のメンバーでプロパティを指定することによって、\>保持できます \(これは、ビット マスクであり、個々のコントロール バーのビットは **AFX\_CONTROLBAR\_MASK** \(AFX\_IDW\_MYBAR\) によって定義されます。  ウィンドウの pState\-\>**nIDMainPane** が自動的に非表示 reshown ウィンドウです。  **DoPrintPreview** は、標準プレビュー UI のボタン バーを作成します。  他のウィンドウを表示または非表示にする必要があることを示すために特別なウィンドウの処理は必要などです **DoPrintPreview** が呼び出される前に、  
  
 印刷プレビューは、終了時に既定で、元の状態にコントロール バーと表示にメイン ペインを返します。  特別な処理が必要な場合は、**EndPrintPreview.**のオーバーライドということです。**DoPrintPreview** が失敗した場合、特別な処理を提供します。  
  
 DoPrintPreview は次のように ICorProfilerCallback2:  
  
-   プレビュー バーのダイアログ テンプレートのリソース id。  
  
-   印刷プレビューの印刷を実行ビューへのポインター。  
  
-   プレビュー ビュー クラスのランタイム クラス。  これは DoPrintPreview で動的に作成されます。  
  
-   CPrintPreviewState のポインター。  アプリケーションが管理する詳細な状態が必要な場合は CPrintPreviewState 構造体 \(または派生構造体\) 作成できないことにフレームに注意してください。  DoPrintPreview はモードレスであり、EndPrintPreview が呼び出されるまで、この構造体には、保持する必要があります。  
  
    > [!NOTE]
    >  別のビューまたはビュー クラスがサポートを印刷するために必要な場合、そのオブジェクトへのポインターが、2 番目のパラメーターとして渡す必要があります。  
  
## EndPrintPreview  
 これが印刷プレビュー モードを終了します。  多くの場合、印刷プレビューの最後に表示されるドキュメントのページに移動することが望まれます。  **EndPrintPreview** は そのアプリケーションの可能性があります。  pInfo\-の`m_nCurPage` の\>メンバーが 2 ページが表示されたら、最後に \(左端\) 表示された、ポインターがに関してページでユーザーが必要なヒントにページです。  アプリケーションのビューの構造がフレームワークに不明なので、選択されたポイントに移動するコードを記述する必要があります。  
  
 **CView::EndPrintPreview**を呼び出す前に、ほとんどの操作を実行します。  この呼び出しは **DoPrintPreview** の効果を元に戻し、pView、pDC と pInfo を削除します。  
  
```  
// Any further cleanup should be done here.  
CView::EndPrintPreview(pDC, pInfo, point, pView);  
```  
  
## CWinApp::OnFilePrintSetup  
 これが印刷設定のメニュー項目に割り当てる必要があります。  ほとんどの場合、実装をオーバーライドする必要はありません。  
  
## ページの専用語  
 別の問題は、ページ番号、および順序の場合です。  単純なワード プロセッサで型応用の場合、これは単純な問題です。  ほとんどの印刷プレビュー システムは各ページが印刷ドキュメントの 1 ページに対応すると仮定します。  
  
 汎用ソリューションを提供することで考慮する必要があるいくつかの点があります。  CAD システムとします。  ユーザーが複数の E サイズのシートをカバーする描画があります。  E サイズ \(または小さいの、スケーリング\) プロッターで、ページ番号は単純な例のようになります。  ただし、シート 1 冊あたりのサイズ 16 のページを印刷するレーザのプリンターで印刷プレビューは、「ページ」として扱います。  
  
 入門段落の状態は、印刷プレビューはプリンターのように動作します。  したがって、ユーザーが選択した特定のプリンターを終了処理を参照します。  これは、イメージの各ページが印刷されるかを決定するビューがあります。  
  
 `CPrintInfo` 構造体のページの説明文字列には、ユーザーがページごとに 1 回の数として表すことができるページ番号を表示する一つの方法を提供します \(「1 " "のようにしか」\)。この文字列は **CPreviewView::OnDisplayPageNumber**の既定の実装によって使用されます。  別の表示が必要な場合は、1 を指定すると、たとえば、Sheet1 のセクション「A "、" B」を提供するには、この仮想関数をオーバーライドすることもあります。  
  
## 参照  
 [番号順テクニカル ノート](../mfc/technical-notes-by-number.md)   
 [カテゴリ別テクニカル ノート](../mfc/technical-notes-by-category.md)